name: OpenWrt NSS Build

on:
  repository_dispatch:
    types: [upstream_update]
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Check for updates every 6 hours

jobs:
  check_upstream:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_hash: ${{ steps.check.outputs.latest_hash }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Upstream
        id: check
        run: |
          UPSTREAM_URL="https://github.com/qosmio/openwrt-ipq.git"
          BRANCH="main-nss"
          
          # Get latest commit hash from upstream
          LATEST_HASH=$(git ls-remote $UPSTREAM_URL refs/heads/$BRANCH | awk '{print $1}')
          
          echo "Latest upstream hash: $LATEST_HASH"
          
          # Read stored hash from variable (if exists) or file
          # We use a repository variable for persistence. 
          # Note: This requires the workflow to have read access to variables.
          # If variable is empty, we default to building.
          LAST_BUILT_HASH="${{ vars.LAST_BUILT_HASH }}"
          
          echo "Last built hash: $LAST_BUILT_HASH"
          
          if [ "$LATEST_HASH" != "$LAST_BUILT_HASH" ]; then
            echo "New commit found ($LATEST_HASH). Triggering build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "latest_hash=$LATEST_HASH" >> $GITHUB_OUTPUT
          else
            echo "Upstream matches last build ($LAST_BUILT_HASH). Skipping."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi


  build:
    needs: check_upstream
    if: ${{ needs.check_upstream.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch' }}
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        device:
          - { profile: linksys_mr7350,     name: "Linksys MR7350"       }
          - { profile: linksys_mr7500,     name: "Linksys MR7500"       }
          - { profile: glinet_gl-ax1800,   name: "GL.iNet GL-AX1800"    }
          - { profile: glinet_gl-axt1800,  name: "GL.iNet GL-AXT1800"   }
          - { profile: linksys_mx4200v2,   name: "Linksys MX4200 v2"    }
          - { profile: linksys_mx4300,     name: "Linksys MX4300"       }
          - { profile: netgear_wax620,     name: "Netgear WAX620"       }
          - { profile: dynalink_dl-wrx36,  name: "Dynalink DL-WRX36"   }
          - { profile: zyxel_nbg7815,      name: "Zyxel NBG7815"        }
          - { profile: xiaomi_ax3600,      name: "Xiaomi AX3600"        }
    steps:
    - uses: actions/checkout@v4

    - name: Update tzdata
      run: sudo apt-get update && sudo apt-get install -y tzdata fuse3

    - name: Enable /dev/fuse
      run: |
        sudo modprobe fuse || true
        sudo chmod 666 /dev/fuse
        sudo chown root:$(id -gn) /dev/fuse

    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Magic Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Cache OpenWrt dl directory
      uses: actions/cache@v4
      with:
        path: dl
        key: ${{ runner.os }}-openwrt-dl-${{ matrix.device.profile }}-${{ needs.check_upstream.outputs.latest_hash }}-${{ hashFiles('flake.nix', 'packages.txt') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-${{ matrix.device.profile }}-
          ${{ runner.os }}-openwrt-dl-

    - name: Cache OpenWrt ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ${{ runner.os }}-openwrt-ccache-${{ matrix.device.profile }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-ccache-${{ matrix.device.profile }}-
          ${{ runner.os }}-openwrt-ccache-

    - name: Prepare cache directories
      run: |
        mkdir -p dl
        mkdir -p .ccache

    - name: Update flake.lock
      run: nix flake update

    - name: Build OpenWrt Image (${{ matrix.device.name }})
      env:
        CI: "1"
      run: nix develop --impure --command build-nss-image --profile ${{ matrix.device.profile }}

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.device.profile }}
        path: |
          ./*.log
          ./**/*.log
        if-no-files-found: warn

    - name: Setup SSH Session
      if: failure()
      uses: Warpbuilds/action-debugger@v1.3

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ matrix.device.profile }}
        path: source/bin/
        if-no-files-found: warn

    - name: Upload to Release
      uses: softprops/action-gh-release@v2.4.2
      if: success()
      with:
        files: |
          source/bin/targets/**/*.bin
          source/bin/targets/**/*.itb
        tag_name: ${{ needs.check_upstream.outputs.latest_hash || github.sha }}
        name: OpenWrt NSS Build
        token: ${{ secrets.RELEASE_TOKEN }}
        prerelease: true
        body: |
          ## ${{ matrix.device.name }}

          * **Upstream Commit:** https://github.com/qosmio/openwrt-ipq/commit/${{ needs.check_upstream.outputs.latest_hash || 'N/A' }}
          * **Build Commit:** ${{ github.sha }}
          * **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  post_build:
    needs: [check_upstream, build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Update flake.lock
      run: nix flake update

    - name: Commit updated flake.lock
      run: |
        if [[ -n "$(git status --porcelain flake.lock)" ]]; then
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add flake.lock
          git commit -m "chore: update flake.lock [skip ci]"
          git push
        else
          echo "flake.lock is already up to date."
        fi

    - name: Update Last Built Hash
      if: needs.check_upstream.outputs.latest_hash != ''
      env:
        GH_TOKEN: ${{ secrets.WRITE_TO_VAR }}
      run: |
        echo "Updating LAST_BUILT_HASH to ${{ needs.check_upstream.outputs.latest_hash }}"
        gh variable set LAST_BUILT_HASH \
          --body "${{ needs.check_upstream.outputs.latest_hash }}" \
          --repo ${{ github.repository }}